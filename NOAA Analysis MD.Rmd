---
title: "Effects of Major Storm Events on U.S. Population Health and Economy"
author: "Ashly Yashchin"
date: "6/6/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Synopsis
Placeholder Text.

##Loading and Processing the Raw Data
This data has been provided by the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. It can be found [here](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2). The supporting data documentation can be found [here](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf).

###Reading in the Data
```{r}
dataUrl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
if(!file.exists("./data")){dir.create("./data")}
data <- download.file(dataUrl,destfile="./data/NOAA_storm_data.zip")
data <- read.csv("./data/NOAA_storm_data.zip",header=TRUE,sep=",")
dim(data)
head(data)
```

###Processing the Raw Data
First, let's identify the questions we are trying to solve:

1. Across the United States, which types of events (as indicated in the 𝙴𝚅𝚃𝚈𝙿𝙴 variable) are most harmful with respect to population health?

2. Across the United States, which types of events have the greatest economic consequences?

Great, now that we know what we're trying to answer, we can process the raw data and prep it for analysis. Let's create two new data subsets, one for each question. We will call them "healthdata" and "economicdata" respectively. We will use the dplyr package to assist.

```{r}
library(dplyr)
healthdata <- data %>% select(EVTYPE,STATE__,STATE,FATALITIES,INJURIES,REFNUM)
```
Let's check for missing values:
```{r} sum(is.na(healthdata$FATALITIES))```

There are no missing values. This data set is ready for manipulation and analysis.
Now, let's create our second subset.

```{r}
economicdata <- data %>% select(EVTYPE,STATE__,STATE,PROPDMG,PROPDMGEXP,CROPDMG,CROPDMGEXP,REFNUM)
```

Let's check for missing values:
```{r} sum(is.na(economicdata$PROPDMG))+sum(is.na(economicdata$CROPDMG))```

There are no missing values. This data set is ready for manipulation and analysis.

##Results
Before we begin, let's create a data frame that shows us the number of times each event occurs. We will use this later to determine the risk by impact per event.

```{r}
event_occurence <- as.data.frame(summary(data$EVTYPE))
event_occurence <- rename(event_occurence,Frequency=`summary(data$EVTYPE)`)
```


###Analysis of storm events on U.S. health outcomes.
Using our "healthdata" subset, we will conduct an analysis to answer Question 1. Let's start by taking a quick look at our dataset. 

```{r} 
dim(healthdata)
head(healthdata)
```
Let's add a column called "TOTAL" which sums the number of Fatalities and Injuries and arrange in descending order.

```{r}
healthdata <- healthdata %>% mutate(BOTH=FATALITIES+INJURIES) %>% select(EVTYPE:INJURIES,BOTH) %>% arrange(desc(BOTH))
head(healthdata)
```

Eek, wouldn't want to be caught in a tornado! Now, let's get a sum for each impact (i.e. fatality or injury) by event and save it to a new variable. Since we're looking for the events with the greatest impact on health, let's remove those that have no impact.
```{r}
eventhealth <- healthdata %>% group_by(EVTYPE) %>% select(EVTYPE,FATALITIES:BOTH) %>% summarize_each(funs(sum)) %>% arrange(desc(BOTH)) %>% filter(BOTH>0)
summary(eventhealth)
eventhealth[1:20,]
```

Finally, let's add a column that shows the total times this event occurs and the number of fatalities or injuries per event. 

```{r}
eventhealth <- merge(eventhealth,event_occurence,by.x="EVTYPE",by.y='row.names') %>% arrange(desc(Frequency)) 
head(eventhealth)
```

Looks like hail is our most frequent weather event, although it appears to have a relatively low impact. Let's confirm this by determining the impact on a per event basis. We will divide the number of fatalities and injuries by the number of event occurances to determine how many fatalities or injuries there were per occurance.
```{r}
eventhealth <- eventhealth %>% mutate(riskFatal=FATALITIES/Frequency,riskInjury=INJURIES/Frequency,riskBoth=BOTH/Frequency) %>% arrange(desc(riskBoth)) %>% rename(Fatalities = riskFatal,Injuries=riskInjury)
eventhealth[1:20,]
```

Wow, tornados don't seem that scary after all. Looks like we should be much more afraid of getting caught in heat or a rip current. By looking at the health impact on a per event basis versus a total, we were able to control for the large outlier that Tornados were at the total level. We now know that while tornados can be extremely detrimental and harm large amounts of the population at one time, the risk of them being that impactful is rarer than had appeared on the surface. 

We now have a complete table that can inform officials on the potential risk of any extreme weather event on human health so that they can allocate resources and prep response teams appropriately. 

For a quick visual, we can create a plot of just the top 10. 

```{r}
library(reshape2)
library(ggplot2)
worstevents <- melt(select(eventhealth[1:10,],c(EVTYPE,Fatalities:Injuries)))
ggplot(worstevents,aes(x=EVTYPE,y=value,fill=variable))+geom_bar(stat="identity",position="stack") + theme(axis.text.x = element_text(angle=90,hjust = 1)) + xlab("Extreme Weather Event") + ylab("Occurence per Event") + ggtitle("Extreme Weather Event Human Impact")
```

This quick visual shows us that there are various high impact events that seem similar and could probably be grouped (i.e. "excessive heat", "heat" and "heat wave" or "rip current" and "rip currents"), however that would require studying the data collection methods and category assignment more closely and determining if grouping were appropriate. For now we will leave it as is. 